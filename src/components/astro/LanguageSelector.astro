---
// Credits: https://github.com/yassinedoghri/astro-i18next/blob/beta/src/components/LanguageSelector.astro
// Edited for this project needs.

import ISO6991 from "iso-639-1";
import { getLocale, localeKeys, getLocaleUrl } from "astro-i18n-aut";

export interface Props {
    showFlag?: boolean;
    showTitle?: boolean;
    placement?: string;
    buttonId: string;
    dropdownId: string;
    additionalClassList?: string[];
}

const locale = getLocale(Astro.url);
const { pathname } = Astro.url;
const { showFlag = false, showTitle = true, placement = "bottom", additionalClassList = [], buttonId, dropdownId } = Astro.props;
const capitalizeFirstLetter = (str: string) => {
    const capitalized = str.charAt(0).toUpperCase() + str.slice(1);
    return capitalized;
};
---

<div class="language-selector">
    <button class:list={["dropdown"].concat(additionalClassList)} data-dropdown-target={`#${dropdownId}`} data-dropdown-placement={placement} id={buttonId}>
        {showFlag && <span class={`flag ${locale}`} />}
        {showTitle ? capitalizeFirstLetter(ISO6991.getNativeName(locale)) : ""}
    </button>
    <ul class="dropdown-content" id={dropdownId} data-js-current-language={locale}>
        {
            localeKeys.map((supportedLanguage: string) => {
                let value = getLocaleUrl(pathname, supportedLanguage);
                const nativeName = capitalizeFirstLetter(ISO6991.getNativeName(supportedLanguage));

                return (
                    <li>
                        <a href={value} rel="prefetch" data-js-language={supportedLanguage}>
                            {showFlag && <span class={`flag ${supportedLanguage}`} />}
                            <span>{nativeName}</span>
                            <i class={supportedLanguage == locale ? "fa fa-check" : ""} aria-hidden="true" />
                        </a>
                    </li>
                );
            })
        }
    </ul>
</div>

<script>
    const languageSelector = document.querySelectorAll("[data-js-language]");
    languageSelector.forEach((selector) => {
        selector.addEventListener("click", function (e) {
            let currectSelector = e.target as HTMLAnchorElement;
            let selectedLanguage = currectSelector.getAttribute("data-js-language");
            if (selectedLanguage === null) {
                console.error("Could not find 'data-js-language' attribute.");
                return;
            }
            window.localStorage.setItem("language", selectedLanguage);
        });
    });
</script>

<style>
    span,
    i {
        pointer-events: none;
    }

    .flag {
        background-size: contain;
        background-position: 50%;
        background-repeat: no-repeat;
        display: inline-block;
        width: 15px;
        height: 10px;
        margin-right: 0.5rem;
        &.cs {
            background-image: url(/assets/img/flags/cz.svg);
        }
        &.en {
            background-image: url(/assets/img/flags/us.svg);
        }
    }

    .flag .flag .language-selector {
        display: flex;
        justify-content: center;
        font-size: 1rem;
        position: relative;
        height: 60px;
    }

    button {
        background-color: transparent;
        color: var(--accent-color);
        font-family: inherit;
        border: none;
        transition: all 200ms;
        cursor: pointer;
        font-size: inherit;
        text-transform: uppercase;
        font-weight: 600;
        position: relative;
        padding: 0;
    }

    button::after {
        display: inline-block;
        margin-left: 0.255em;
        vertical-align: 0.255em;
        content: "";
        border-top: 0.3em solid;
        border-right: 0.3em solid transparent;
        border-bottom: 0;
        border-left: 0.3em solid transparent;
    }
</style>
